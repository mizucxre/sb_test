{% extends "base.html" %}

{% block page_title %}Рассылки{% endblock %}

{% block content %}
<div x-data="broadcast()" class="space-y-4 lg:space-y-6">
    <div class="glass-effect rounded-2xl p-4 lg:p-6">
        <h3 class="text-base lg:text-lg font-semibold mb-3 lg:mb-4">Рассылка сообщений</h3>
        
        <div class="responsive-grid gap-3 lg:gap-6 mb-4 lg:mb-6">
            <button @click="setType('unpaid')" 
                    class="p-4 lg:p-6 rounded-2xl border transition-all duration-200 text-left"
                    :class="type === 'unpaid' ? 'bg-yellow-500/20 border-yellow-500/50' : 'bg-white/5 border-white/10 hover:border-white/20'"
                    data-touch-target>
                <div class="flex items-center space-x-3 mb-2 lg:mb-3">
                    <i class="fas fa-exclamation-triangle text-yellow-400 text-lg lg:text-2xl"></i>
                    <h4 class="font-semibold text-sm lg:text-base">Неплательщики</h4>
                </div>
                <p class="text-gray-400 text-xs lg:text-sm">Уведомление пользователям, которые не оплатили заказ</p>
            </button>

            <button @click="setType('all')" 
                    class="p-4 lg:p-6 rounded-2xl border transition-all duration-200 text-left"
                    :class="type === 'all' ? 'bg-blue-500/20 border-blue-500/50' : 'bg-white/5 border-white/10 hover:border-white/20'"
                    data-touch-target>
                <div class="flex items-center space-x-3 mb-2 lg:mb-3">
                    <i class="fas fa-users text-blue-400 text-lg lg:text-2xl"></i>
                    <h4 class="font-semibold text-sm lg:text-base">Все пользователи</h4>
                </div>
                <p class="text-gray-400 text-xs lg:text-sm">Сообщение всем пользователям бота</p>
            </button>
        </div>

        <div x-show="type">
            <label class="block text-sm font-medium text-gray-400 mb-2">Сообщение</label>
            <textarea x-model="message" rows="4"
                      class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all duration-200"
                      placeholder="Введите текст сообщения..."
                      data-touch-target></textarea>
            
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-2 lg:space-y-0 mt-4 lg:mt-6">
                <span class="text-gray-400 text-sm text-center lg:text-left" x-text="`Длина: ${message.length} символов`"></span>
                <button @click="sendBroadcast()" 
                        :disabled="!message || loading"
                        class="btn-primary px-4 py-3 rounded-2xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 text-sm lg:text-base"
                        data-touch-target>
                    <i class="fas fa-spinner fa-spin mr-2" x-show="loading"></i>
                    Отправить
                </button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div x-show="result" 
         x-transition:enter="transition-all duration-300 ease-out"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         class="glass-effect rounded-2xl p-4 lg:p-6">
        <h3 class="text-base lg:text-lg font-semibold mb-3 lg:mb-4">Результаты рассылки</h3>
        <div class="space-y-2">
            <div class="flex items-center justify-between">
                <span class="text-gray-400 text-sm">Отправлено:</span>
                <span class="text-green-400 text-sm" x-text="result.sent || 0"></span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-gray-400 text-sm">Не удалось отправить:</span>
                <span class="text-red-400 text-sm" x-text="result.failed || 0"></span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-gray-400 text-sm">Всего:</span>
                <span class="text-sm" x-text="result.total || 0"></span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('broadcast', () => ({
        type: '',
        message: '',
        loading: false,
        result: null,
        
        setType(selectedType) {
            this.type = selectedType;
            this.result = null;
        },
        
        async sendBroadcast() {
            this.loading = true;
            this.result = null;
            
            try {
                const url = this.type === 'unpaid' 
                    ? '/admin/api/broadcast/unpaid' 
                    : '/admin/api/broadcast/all';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: this.message
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Ошибка сервера');
                }
                
                const data = await response.json();
                this.result = data.result;
                
                if (window.Alpine && Alpine.$data && Alpine.$data.pageUtils) {
                    Alpine.$data.pageUtils.showNotification('Рассылка отправлена успешно', 'success');
                }
                
            } catch (error) {
                console.error('Error sending broadcast:', error);
                if (window.Alpine && Alpine.$data && Alpine.$data.pageUtils) {
                    Alpine.$data.pageUtils.showNotification('Ошибка при отправке рассылки: ' + error.message, 'error');
                }
            } finally {
                this.loading = false;
            }
        }
    }));
});
</script>
{% endblock %}
