{% extends "base.html" %}

{% block page_title %}Управление заказами{% endblock %}

{% block content %}
<div x-data="orders()" class="space-y-6">
    <!-- Filters -->
    <div class="glass-effect rounded-2xl p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Статус</label>
                <select x-model="filters.status" class="styled-select w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
                    <option value="">Все статусы</option>
                    {% for status in statuses %}
                    <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Страна</label>
                <select x-model="filters.country" class="styled-select w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
                    <option value="">Все страны</option>
                    <option value="CN">Китай (CN)</option>
                    <option value="KR">Корея (KR)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Поиск</label>
                <input type="text" x-model="filters.search" placeholder="Order ID..." class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
            </div>
            <div class="flex items-end space-x-2">
                <button @click="applyFilters()" class="flex-1 btn-primary px-4 py-2 rounded-2xl font-medium transition-all duration-200">
                    Применить
                </button>
                <button @click="resetFilters()" class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-2xl px-4 py-2 transition-all duration-200">
                    Сбросить
                </button>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="glass-effect rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold">Список заказов</h3>
            <a href="/admin/orders/new" class="btn-primary px-6 py-2 rounded-2xl font-medium">
                <i class="fas fa-plus mr-2"></i>Новый заказ
            </a>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Order ID</th>
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Клиент</th>
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Статус</th>
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Страна</th>
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Обновлен</th>
                        <th class="text-left py-4 px-4 text-gray-400 font-medium">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="loading">
                        <tr>
                            <td colspan="6" class="py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Загрузка заказов...</p>
                            </td>
                        </tr>
                    </template>
                    <template x-if="!loading && filteredOrders.length === 0">
                        <tr>
                            <td colspan="6" class="py-8 text-center text-gray-400">
                                <i class="fas fa-inbox text-2xl mb-2"></i>
                                <p>Заказы не найдены</p>
                            </td>
                        </tr>
                    </template>
                    <template x-for="order in filteredOrders" :key="order.order_id">
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-colors duration-200">
                            <td class="py-4 px-4">
                                <span class="font-mono font-semibold" x-text="order.order_id"></span>
                            </td>
                            <td class="py-4 px-4">
                                <div x-text="order.client_name" class="truncate max-w-xs"></div>
                            </td>
                            <td class="py-4 px-4">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium" 
                                      :class="getStatusClass(order.status)" 
                                      x-text="order.status"></span>
                            </td>
                            <td class="py-4 px-4">
                                <span x-text="order.country" class="font-mono"></span>
                            </td>
                            <td class="py-4 px-4 text-gray-400 text-sm" x-text="formatDate(order.updated_at)"></td>
                            <td class="py-4 px-4">
                                <div class="flex items-center space-x-2">
                                    <button @click="viewOrder(order.order_id)" class="p-2 text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 rounded-2xl transition-all duration-200">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="editOrder(order.order_id)" class="p-2 text-green-400 hover:text-green-300 hover:bg-green-500/10 rounded-2xl transition-all duration-200">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteOrder(order.order_id)" class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-2xl transition-all duration-200">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-6">
            <div class="text-gray-400 text-sm">
                Показано <span x-text="filteredOrders.length"></span> из <span x-text="totalOrders"></span> заказов
            </div>
            <div class="flex items-center space-x-2">
                <button @click="prevPage()" :disabled="currentPage === 1" class="p-2 rounded-2xl bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="px-4 py-2 text-sm">Страница <span x-text="currentPage"></span></span>
                <button @click="nextPage()" :disabled="!hasMore" class="p-2 rounded-2xl bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('orders', () => ({
        orders: [],
        filteredOrders: [],
        filters: {
            status: '',
            country: '',
            search: ''
        },
        currentPage: 1,
        itemsPerPage: 10,
        totalOrders: 0,
        hasMore: false,
        loading: true,
        
        init() {
            this.loadOrders();
        },
        
        async loadOrders() {
            this.loading = true;
            try {
                let url = '/admin/api/orders?limit=100';
                if (this.filters.status) {
                    url += `&status=${this.filters.status}`;
                }
                if (this.filters.country) {
                    url += `&country=${this.filters.country}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                this.orders = data.orders || [];
                this.totalOrders = data.total || 0;
                this.hasMore = data.has_more || false;
                this.applyFilters();
            } catch (error) {
                console.error('Error loading orders:', error);
                alert('Ошибка загрузки заказов');
            } finally {
                this.loading = false;
            }
        },
        
        applyFilters() {
            let filtered = this.orders;
            
            if (this.filters.search) {
                const searchTerm = this.filters.search.toLowerCase();
                filtered = filtered.filter(order => 
                    order.order_id.toLowerCase().includes(searchTerm) ||
                    order.client_name.toLowerCase().includes(searchTerm)
                );
            }
            
            this.filteredOrders = filtered;
        },
        
        resetFilters() {
            this.filters = {
                status: '',
                country: '',
                search: ''
            };
            this.loadOrders();
        },
        
        getStatusClass(status) {
            const statusClasses = {
                'новый': 'bg-blue-500/20 text-blue-400',
                'в обработке': 'bg-yellow-500/20 text-yellow-400',
                'доставлен': 'bg-green-500/20 text-green-400',
                'получен': 'bg-purple-500/20 text-purple-400',
                'отменен': 'bg-red-500/20 text-red-400'
            };
            
            for (const [key, value] of Object.entries(statusClasses)) {
                if (status.toLowerCase().includes(key)) {
                    return value;
                }
            }
            
            return 'bg-gray-500/20 text-gray-400';
        },
        
        viewOrder(orderId) {
            window.location.href = `/admin/orders/${orderId}`;
        },
        
        editOrder(orderId) {
            window.location.href = `/admin/orders/${orderId}/edit`;
        },
        
        async deleteOrder(orderId) {
            if (confirm(`Удалить заказ ${orderId}?`)) {
                try {
                    const response = await fetch(`/admin/api/orders/${orderId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    alert(result.message);
                    this.loadOrders();
                } catch (error) {
                    console.error('Error deleting order:', error);
                    alert('Ошибка при удалении заказа');
                }
            }
        },
        
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadOrders();
            }
        },
        
        nextPage() {
            if (this.hasMore) {
                this.currentPage++;
                this.loadOrders();
            }
        },
        
        formatDate(dateString) {
            if (!dateString) return 'Неизвестно';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }));
});
</script>
{% endblock %}
