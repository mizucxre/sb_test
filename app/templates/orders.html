{% extends "base.html" %}

{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏{% endblock %}

{% block content %}
<div x-data="orders()" class="space-y-4 lg:space-y-6">
    <!-- Bulk Actions (Mobile Optimized) -->
    <div x-show="selectedOrders.length > 0" 
         x-transition:enter="transition-all duration-300 ease-out"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition-all duration-200 ease-in"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform translate-y-4"
         class="glass-effect rounded-2xl p-4 lg:p-6">
        
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
            <div class="flex items-center space-x-3">
                <span class="text-gray-400 text-sm lg:text-base">–í—ã–±—Ä–∞–Ω–æ: <span x-text="selectedOrders.length" class="font-semibold text-white"></span></span>
            </div>
            
            <div class="flex flex-col lg:flex-row space-y-2 lg:space-y-0 lg:space-x-3">
                <select x-model="bulkAction" 
                        class="custom-select w-full lg:w-auto bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-sm lg:text-base"
                        data-touch-target>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ...</option>
                    <option value="update_status">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</option>
                    <option value="delete">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</option>
                </select>
                
                <div x-show="bulkAction === 'update_status'" class="flex flex-col lg:flex-row space-y-2 lg:space-y-0 lg:space-x-2">
                    <select x-model="bulkStatus" 
                            class="custom-select w-full lg:w-auto bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-sm lg:text-base"
                            data-touch-target>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
                        {% for status in statuses %}
                        <option value="{{ status }}">{{ status }}</option>
                        {% endfor %}
                    </select>
                    <button @click="applyBulkAction()" 
                            class="btn-primary px-4 py-3 rounded-2xl font-medium transition-all duration-200 text-sm lg:text-base"
                            data-touch-target>
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
                
                <button x-show="bulkAction === 'delete'" 
                        @click="applyBulkAction()" 
                        class="btn-primary px-4 py-3 rounded-2xl font-medium transition-all duration-200 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 text-sm lg:text-base"
                        data-touch-target>
                    –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
            </div>
            
            <button @click="clearSelection()" 
                    class="text-gray-400 hover:text-white transition-colors duration-200 p-2 self-end lg:self-auto"
                    data-touch-target>
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
    </div>

    <!-- Filters (Mobile Optimized) -->
    <div class="glass-effect rounded-2xl p-4 lg:p-6">
        <div class="responsive-grid gap-3 lg:gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">–°—Ç–∞—Ç—É—Å</label>
                <select x-model="filters.status" 
                        class="custom-select w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        data-touch-target>
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    {% for status in statuses %}
                    <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">–°—Ç—Ä–∞–Ω–∞</label>
                <select x-model="filters.country" 
                        class="custom-select w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        data-touch-target>
                    <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
                    <option value="CN">–ö–∏—Ç–∞–π (CN)</option>
                    <option value="KR">–ö–æ—Ä–µ—è (KR)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">–ú–µ—Ç–∫–∞ –ê–¥–º–∏–Ω–∞</label>
                <select x-model="filters.note" 
                        class="custom-select w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                        data-touch-target>
                    <option value="">–í—Å–µ –º–µ—Ç–∫–∏</option>
                    <template x-for="note in uniqueNotes" :key="note">
                        <option x-text="note" :value="note"></option>
                    </template>
                </select>
            </div>
            
            <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-400 mb-2">–ü–æ–∏—Å–∫</label>
                <input type="text" 
                       x-model="filters.search" 
                       placeholder="Order ID, –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –º–µ—Ç–∫–∞..." 
                       class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50"
                       data-touch-target>
            </div>
            
            <div class="flex flex-col lg:flex-row lg:items-end space-y-2 lg:space-y-0 lg:space-x-2">
                <button @click="applyFilters()" 
                        class="flex-1 btn-primary px-4 py-3 rounded-2xl font-medium transition-all duration-200 text-sm lg:text-base"
                        data-touch-target>
                    <i class="fas fa-filter mr-2"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <button @click="resetFilters()" 
                        class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-2xl px-4 py-3 transition-all duration-200 text-sm lg:text-base"
                        data-touch-target>
                    <i class="fas fa-undo mr-2"></i>–°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- Orders Table (Mobile Optimized) -->
    <div class="glass-effect rounded-2xl p-4 lg:p-6">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0 mb-4 lg:mb-6">
            <div class="flex items-center space-x-3">
                <h3 class="text-lg lg:text-xl font-semibold">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h3>
                <span class="text-gray-400 text-sm" x-text="`${filteredOrders.length} –∏–∑ ${totalOrders}`"></span>
            </div>
            
            <div class="flex flex-col lg:flex-row space-y-2 lg:space-y-0 lg:space-x-3">
                <button @click="selectAll()" 
                        class="px-4 py-3 rounded-2xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 transition-all duration-200 text-sm lg:text-base"
                        data-touch-target>
                    <i class="fas fa-check-square mr-2"></i>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <a href="/admin/import" 
                   class="px-4 py-3 rounded-2xl bg-green-500/20 hover:bg-green-500/30 text-green-400 border border-green-500/30 hover:border-green-500/50 transition-all duration-200 text-sm lg:text-base text-center"
                   data-touch-target>
                    <i class="fas fa-file-import mr-2"></i>–ò–º–ø–æ—Ä—Ç
                </a>
                <a href="/admin/orders/new" 
                   class="btn-primary px-4 py-3 rounded-2xl font-medium text-sm lg:text-base text-center"
                   data-touch-target>
                    <i class="fas fa-plus mr-2"></i>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                </a>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div class="lg:hidden space-y-3">
            <template x-if="loading">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
                </div>
            </template>
            
            <template x-if="!loading && filteredOrders.length === 0">
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-2xl mb-2"></i>
                    <p class="text-gray-400">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p class="text-sm text-gray-500 mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                </div>
            </template>
            
            <template x-for="order in filteredOrders" :key="order.order_id">
                <div class="bg-white/5 rounded-2xl p-4 border border-white/10 hover:border-white/20 transition-all duration-200"
                     :class="{ 'border-blue-500/30 bg-blue-500/10': selectedOrders.includes(order.order_id) }">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" 
                                   :value="order.order_id" 
                                   x-model="selectedOrders" 
                                   class="rounded bg-white/5 border-white/10 text-blue-500 focus:ring-blue-500/50"
                                   data-touch-target>
                            <span class="font-mono font-semibold text-sm" x-text="order.order_id"></span>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" 
                              :class="getStatusClass(order.status)" 
                              x-text="order.status"></span>
                    </div>
                    
                    <!-- Details -->
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">–ö–ª–∏–µ–Ω—Ç:</span>
                            <span x-text="order.client_name" class="truncate max-w-[120px]"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">–°—Ç—Ä–∞–Ω–∞:</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-mono" 
                                  :class="order.country === 'CN' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'"
                                  x-text="order.country"></span>
                        </div>
                        <div class="flex justify-between" x-show="order.note">
                            <span class="text-gray-400">–ú–µ—Ç–∫–∞:</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-500/20 text-purple-400" 
                                  x-text="order.note"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">–û–±–Ω–æ–≤–ª–µ–Ω:</span>
                            <span class="text-gray-400 text-xs" x-text="formatDate(order.updated_at)"></span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex justify-center space-x-2 mt-3 pt-3 border-t border-white/10">
                        <button @click="viewOrder(order.order_id)" 
                                class="flex-1 p-2 text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 rounded-xl transition-all duration-200 text-center"
                                data-touch-target>
                            <i class="fas fa-eye"></i>
                            <span class="text-xs block mt-1">–ü—Ä–æ—Å–º–æ—Ç—Ä</span>
                        </button>
                        <button @click="editOrder(order.order_id)" 
                                class="flex-1 p-2 text-green-400 hover:text-green-300 hover:bg-green-500/10 rounded-xl transition-all duration-200 text-center"
                                data-touch-target>
                            <i class="fas fa-edit"></i>
                            <span class="text-xs block mt-1">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button @click="deleteOrder(order.order_id)" 
                                class="flex-1 p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition-all duration-200 text-center"
                                data-touch-target>
                            <i class="fas fa-trash"></i>
                            <span class="text-xs block mt-1">–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Desktop Table View -->
        <div class="hidden lg:block">
            <div class="mobile-table-container touch-scroll">
                <table class="mobile-table">
                    <thead>
                        <tr class="border-b border-white/10">
                            <th class="text-left py-4 px-4 text-gray-400 font-medium w-12">
                                <input type="checkbox" 
                                       @change="toggleAll()" 
                                       :checked="selectedOrders.length === filteredOrders.length && filteredOrders.length > 0" 
                                       class="rounded bg-white/5 border-white/10 text-blue-500 focus:ring-blue-500/50"
                                       data-touch-target>
                            </th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">Order ID</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–ö–ª–∏–µ–Ω—Ç</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–°—Ç–∞—Ç—É—Å</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–°—Ç—Ä–∞–Ω–∞</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–ú–µ—Ç–∫–∞ –ê–¥–º–∏–Ω–∞</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–û–±–Ω–æ–≤–ª–µ–Ω</th>
                            <th class="text-left py-4 px-4 text-gray-400 font-medium">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="loading">
                            <tr>
                                <td colspan="8" class="py-8 text-center text-gray-400">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
                                </td>
                            </tr>
                        </template>
                        
                        <template x-if="!loading && filteredOrders.length === 0">
                            <tr>
                                <td colspan="8" class="py-8 text-center text-gray-400">
                                    <i class="fas fa-inbox text-2xl mb-2"></i>
                                    <p>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                    <p class="text-sm mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                                </td>
                            </tr>
                        </template>
                        
                        <template x-for="order in filteredOrders" :key="order.order_id">
                            <tr class="border-b border-white/5 hover:bg-white/5 transition-colors duration-200" 
                                :class="{ 'bg-blue-500/10': selectedOrders.includes(order.order_id) }">
                                
                                <td class="py-4 px-4">
                                    <input type="checkbox" 
                                           :value="order.order_id" 
                                           x-model="selectedOrders" 
                                           class="rounded bg-white/5 border-white/10 text-blue-500 focus:ring-blue-500/50"
                                           data-touch-target>
                                </td>
                                
                                <td class="py-4 px-4">
                                    <span class="font-mono font-semibold" x-text="order.order_id"></span>
                                </td>
                                
                                <td class="py-4 px-4">
                                    <div x-text="order.client_name" class="truncate max-w-xs"></div>
                                </td>
                                
                                <td class="py-4 px-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium" 
                                          :class="getStatusClass(order.status)" 
                                          x-text="order.status"></span>
                                </td>
                                
                                <td class="py-4 px-4">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-mono" 
                                          :class="order.country === 'CN' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'"
                                          x-text="order.country"></span>
                                </td>
                                
                                <td class="py-4 px-4">
                                    <template x-if="order.note">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-500/20 text-purple-400" x-text="order.note"></span>
                                    </template>
                                    <template x-if="!order.note">
                                        <span class="text-gray-500 text-xs">‚Äî</span>
                                    </template>
                                </td>
                                
                                <td class="py-4 px-4 text-gray-400 text-sm" x-text="formatDate(order.updated_at)"></td>
                                
                                <td class="py-4 px-4">
                                    <div class="mobile-table-actions">
                                        <button @click="viewOrder(order.order_id)" 
                                                class="p-2 text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 rounded-2xl transition-all duration-200" 
                                                title="–ü—Ä–æ—Å–º–æ—Ç—Ä"
                                                data-touch-target>
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button @click="editOrder(order.order_id)" 
                                                class="p-2 text-green-400 hover:text-green-300 hover:bg-green-500/10 rounded-2xl transition-all duration-200" 
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                                data-touch-target>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="deleteOrder(order.order_id)" 
                                                class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-2xl transition-all duration-200" 
                                                title="–£–¥–∞–ª–∏—Ç—å"
                                                data-touch-target>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0 mt-4 lg:mt-6">
            <div class="text-gray-400 text-sm text-center lg:text-left">
                –ü–æ–∫–∞–∑–∞–Ω–æ <span x-text="filteredOrders.length" class="font-semibold text-white"></span> –∏–∑ <span x-text="totalOrders" class="font-semibold text-white"></span> –∑–∞–∫–∞–∑–æ–≤
            </div>
            
            <div class="flex items-center justify-center space-x-2">
                <button @click="prevPage()" 
                        :disabled="currentPage === 1 || loading" 
                        class="p-3 rounded-2xl bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                        data-touch-target>
                    <i x-show="!loading" class="fas fa-chevron-left"></i>
                    <i x-show="loading" class="fas fa-spinner fa-spin"></i>
                </button>
                
                <span class="px-4 py-2 text-sm">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span x-text="currentPage" class="font-semibold"></span></span>
                
                <button @click="nextPage()" 
                        :disabled="!hasMore || loading" 
                        class="p-3 rounded-2xl bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                        data-touch-target>
                    <i x-show="!loading" class="fas fa-chevron-right"></i>
                    <i x-show="loading" class="fas fa-spinner fa-spin"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('orders', () => ({
        orders: [],
        filteredOrders: [],
        selectedOrders: [],
        filters: {
            status: '',
            country: '',
            note: '',
            search: ''
        },
        bulkAction: '',
        bulkStatus: '',
        currentPage: 1,
        itemsPerPage: 20, // Reduced for mobile performance
        totalOrders: 0,
        hasMore: false,
        loading: true,
        uniqueNotes: [],
        
        init() {
            this.loadOrders();
            // Lazy load images if any
            if (window.Alpine && Alpine.$data && Alpine.$data.pageUtils) {
                Alpine.$data.pageUtils.lazyLoadImages();
            }
        },
        
        async loadOrders() {
            this.loading = true;
            try {
                const offset = (this.currentPage - 1) * this.itemsPerPage;
                let url = `/admin/api/orders?limit=${this.itemsPerPage}&offset=${offset}`;
                
                // Add filters to API request
                if (this.filters.status) {
                    url += `&status=${encodeURIComponent(this.filters.status)}`;
                }
                if (this.filters.country) {
                    url += `&country=${this.filters.country}`;
                }
                if (this.filters.note) {
                    url += `&note=${encodeURIComponent(this.filters.note)}`;
                }
                if (this.filters.search) {
                    url += `&search=${encodeURIComponent(this.filters.search)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                this.orders = data.orders || [];
                this.totalOrders = data.total || 0;
                this.hasMore = data.has_more || false;
                
                await this.loadUniqueNotes();
                this.filteredOrders = this.orders;
                this.selectedOrders = [];
            } catch (error) {
                console.error('Error loading orders:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ ...
        async loadUniqueNotes() {
            try {
                const response = await fetch('/admin/api/orders/unique-notes');
                if (response.ok) {
                    const data = await response.json();
                    this.uniqueNotes = data.notes || [];
                } else {
                    this.uniqueNotes = [...new Set(this.orders
                        .filter(order => order.note && order.note.trim() !== '')
                        .map(order => order.note)
                        .filter(note => note !== null && note !== undefined))];
                }
            } catch (error) {
                this.uniqueNotes = [...new Set(this.orders
                    .filter(order => order.note && order.note.trim() !== '')
                    .map(order => order.note)
                    .filter(note => note !== null && note !== undefined))];
            }
        },
        
        applyFilters() {
            this.currentPage = 1;
            this.loadOrders();
        },
        
        resetFilters() {
            this.filters = { status: '', country: '', note: '', search: '' };
            this.loadOrders();
        },
        
        getStatusClass(status) {
            const statusMap = {
                'üõí –≤—ã–∫—É–ø–ª–µ–Ω': 'bg-blue-500/20 text-blue-400',
                'üì¶ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å': 'bg-yellow-500/20 text-yellow-400',
                'üì¨ –ø—Ä–∏–µ—Ö–∞–ª –Ω–∞ –∞–¥—Ä–µ—Å': 'bg-purple-500/20 text-purple-400',
                'üõ´ –æ–∂–∏–¥–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É': 'bg-orange-500/20 text-orange-400',
                'üöö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω': 'bg-indigo-500/20 text-indigo-400',
                'üè† –ø—Ä–∏–µ—Ö–∞–ª –∞–¥–º–∏–Ω—É': 'bg-teal-500/20 text-teal-400',
                '‚úÖ –ø–æ–ª—É—á–µ–Ω': 'bg-green-500/20 text-green-400',
                '‚ùå –æ—Ç–º–µ–Ω–µ–Ω': 'bg-red-500/20 text-red-400'
            };
            
            for (const [key, value] of Object.entries(statusMap)) {
                if (status.toLowerCase().includes(key.toLowerCase().replace(/[üõíüì¶üì¨üõ´üööüè†‚úÖ‚ùå]/g, '').trim())) {
                    return value;
                }
            }
            
            return 'bg-gray-500/20 text-gray-400';
        },
        
        viewOrder(orderId) {
            window.location.href = `/admin/orders/${orderId}`;
        },
        
        editOrder(orderId) {
            window.location.href = `/admin/orders/${orderId}/edit`;
        },
        
        async deleteOrder(orderId) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ ${orderId}?`)) {
                try {
                    const response = await fetch(`/admin/api/orders/${orderId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    this.showNotification(result.message, 'success');
                    this.loadOrders();
                } catch (error) {
                    this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
                }
            }
        },
        
        selectAll() {
            this.selectedOrders = this.filteredOrders.map(order => order.order_id);
        },
        
        toggleAll() {
            if (this.selectedOrders.length === this.filteredOrders.length) {
                this.selectedOrders = [];
            } else {
                this.selectAll();
            }
        },
        
        clearSelection() {
            this.selectedOrders = [];
            this.bulkAction = '';
            this.bulkStatus = '';
        },
        
        async applyBulkAction() {
            if (this.selectedOrders.length === 0) {
                this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—ã –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è', 'error');
                return;
            }
            
            if (this.bulkAction === 'update_status') {
                if (!this.bulkStatus) {
                    this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
                    return;
                }
                
                if (confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å ${this.selectedOrders.length} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ "${this.bulkStatus}"?`)) {
                    try {
                        const response = await fetch('/admin/api/orders/bulk-update-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_ids: this.selectedOrders,
                                status: this.bulkStatus
                            })
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.showNotification(result.message, 'success');
                            this.loadOrders();
                            this.clearSelection();
                        } else {
                            this.showNotification(result.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤', 'error');
                        }
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤', 'error');
                    }
                }
            } else if (this.bulkAction === 'delete') {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å ${this.selectedOrders.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤?`)) {
                    try {
                        const response = await fetch('/admin/api/orders/bulk-delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order_ids: this.selectedOrders })
                        });
                        
                        const result = await response.json();
                        if (response.ok) {
                            this.showNotification(result.message, 'success');
                            this.loadOrders();
                            this.clearSelection();
                        } else {
                            this.showNotification(result.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
                        }
                    } catch (error) {
                        this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
                    }
                }
            }
        },
        
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadOrders();
            }
        },
        
        nextPage() {
            if (this.hasMore) {
                this.currentPage++;
                this.loadOrders();
            }
        },
        
        formatDate(dateString) {
            if (!dateString) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        },
        
        showNotification(message, type = 'info') {
            if (window.Alpine && Alpine.$data && Alpine.$data.pageUtils) {
                Alpine.$data.pageUtils.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    }));
});
</script>
{% endblock %}
