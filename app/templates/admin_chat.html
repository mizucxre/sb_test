{% extends "base.html" %}

{% block page_title %}Чат администраторов{% endblock %}

{% block content %}
<div x-data="adminChat()" class="h-full flex flex-col space-y-6">
    <!-- Chat Container -->
    <div class="glass-effect rounded-2xl p-6 flex-1 flex flex-col">
        <h3 class="text-lg font-semibold mb-4">Чат администраторов</h3>
        
        <!-- Messages Container -->
        <div class="flex-1 overflow-y-auto mb-4 space-y-4" id="messages-container">
            <template x-if="loading">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Загрузка сообщений...</p>
                </div>
            </template>
            
            <template x-for="message in messages" :key="message.id">
                <div class="flex items-start space-x-3" :class="message.user_id === currentUser.user_id ? 'flex-row-reverse space-x-reverse' : ''">
                    <img :src="message.avatar_url || 'https://ui-avatars.com/api/?name=' + message.username + '&background=random&size=64'" 
                         :alt="message.username" 
                         class="w-8 h-8 rounded-full flex-shrink-0">
                    
                    <div :class="message.user_id === currentUser.user_id ? 'bg-blue-500/20 border border-blue-500/30' : 'bg-white/5 border border-white/10'"
                         class="rounded-2xl p-3 max-w-xs">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-medium" x-text="message.username"></span>
                            <span class="text-xs text-gray-400" x-text="formatTime(message.created_at)"></span>
                        </div>
                        <p class="text-sm" x-text="message.message"></p>
                    </div>
                </div>
            </template>
            
            <template x-if="!loading && messages.length === 0">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-comments text-2xl mb-2"></i>
                    <p>Пока нет сообщений</p>
                    <p class="text-sm">Начните общение первым!</p>
                </div>
            </template>
        </div>
        
        <!-- Message Input -->
        <div class="flex space-x-2">
            <input type="text" x-model="newMessage" @keyup.enter="sendMessage()"
                   placeholder="Введите сообщение..." 
                   class="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50">
            <button @click="sendMessage()" :disabled="!newMessage.trim()"
                    class="btn-primary px-4 py-2 rounded-2xl font-medium disabled:opacity-50">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('adminChat', () => ({
        messages: [],
        newMessage: '',
        loading: true,
        currentUser: {
            user_id: {{ current_admin.user_id }},
            username: '{{ current_admin.username }}'
        },
        
        async init() {
            await this.loadMessages();
            this.scrollToBottom();
            
            // Автообновление сообщений каждые 5 секунд
            setInterval(() => {
                this.loadMessages();
            }, 5000);
        },
        
        async loadMessages() {
            try {
                const response = await fetch('/admin/api/admin/chat/messages');
                const data = await response.json();
                this.messages = data.messages || [];
                this.loading = false;
                this.scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
                this.loading = false;
            }
        },
        
        async sendMessage() {
            if (!this.newMessage.trim()) return;
            
            try {
                const response = await fetch('/admin/api/admin/chat/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: this.newMessage
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.newMessage = '';
                    await this.loadMessages();
                } else {
                    alert('Ошибка отправки сообщения: ' + result.detail);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Ошибка отправки сообщения');
            }
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('messages-container');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },
        
        formatTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '';
            }
        }
    }));
});
</script>
{% endblock %}
